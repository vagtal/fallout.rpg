<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tile Manager - Pro Edition</title>
    <style>
        :root {
            --primary-color: #a3ff6a;
            --bg-dark: #000;
            --panel-bg: #111;
            --tab-bg: #1a1a1a;
            --tab-active: #302e2e;
            --border: #222;
            --drag-accent: #a3ff6a;
        }

        body, html {
            margin: 0; padding: 0;
            height: 100%; width: 100%;
            background: var(--bg-dark);
            overflow: hidden;
            font-family: system-ui, -apple-system, sans-serif;
            color: #ddd;
        }

        .root {
            height: 100%;
            display: grid;
            gap: 3px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        /* Layouts */
        .layout-double { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; }
        .layout-triple-h { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .layout-triple-h #col-2 { grid-column: 1 / span 2; }
        .layout-triple-v { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .layout-triple-v #col-2 { grid-column: 2; grid-row: 2 / span 2; }
        .layout-triple-v #col-0 { grid-column: 1; grid-row: 1 / span 2 }
        .layout-triple-v #col-1 { grid-column: 2; grid-row: 1; }
        /* Ajuste para el bot√≥n + */
        .iconbtn {
            min-width: 28px;
            font-weight: bold;
        }

        /* Permitir scroll en el men√∫ si la lista de BASE_URLS es muy larga */
        .dropdown-content {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        /* Estilo para los botones del men√∫ de a√±adir */
        .dropdown-content button {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .stack {
            position: relative;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .panel { position: relative; flex: 1; min-height: 0; background: #000; }
        iframe { border: 0; width: 100%; height: 100%; display: block; background: #000; }

        .tab-pane { position: absolute; inset: 0; display: none; }
        .tab-pane.active { display: block; }

        .tabs {
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 6px;
            background: #0b0b0b;
            border-bottom: 1px solid var(--border);
            min-width: 0;
        }

        .tabs-rail {
            flex: 1; 
            display: flex; 
            align-items: center; 
            gap: 6px;
            overflow-x: auto; 
            scrollbar-width: none; 
            min-width: 0;
            padding-right: 20px;
            height: 100%;
        }
        .tabs-rail::-webkit-scrollbar { display: none; }

        .tab {
            flex: 0 0 auto; position: relative; padding: 6px 28px 6px 12px;
            background: var(--tab-bg); color: #ddd; border-radius: 999px;
            font-size: 13px; cursor: grab; border: 1px solid transparent; user-select: none;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        .tab:active { cursor: grabbing; }
        .tab.active { background: var(--tab-active); color: #fff; }
        .tab.dyn::after { content: " ‚Ä¢"; color: var(--primary-color); }
        .tab .close { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 10px; opacity: 0.6; }
        .tab .close:hover { opacity: 1; color: #ff6a6a; }

        /* INDICADORES DE DRAG & DROP */
        .tab.dragging {
            opacity: 0.4;
            border: 1px dashed var(--drag-accent);
            transform: scale(0.95);
        }

        .tab.drag-over {
            background: #2a3a20 !important;
            border-color: var(--drag-accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .tabs-rail.drag-target {
            background: rgba(163, 255, 106, 0.05);
            border-radius: 4px;
        }

        .actions { 
            display: flex; 
            gap: 4px; 
            align-items: center; 
            margin-left: auto;
            padding-left: 8px;
            flex-shrink: 0;
        }

        .iconbtn {
            border: 0; background: var(--tab-bg); color: #fff;
            border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 12px;
            white-space: nowrap;
        }

        .dropdown { position: relative; }
        .dropdown-content {
            display: none; position: absolute; right: 0; top: 30px;
            background: #1a1a1a; border: 1px solid #444; z-index: 1000;
            border-radius: 8px; min-width: 160px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .dropdown-content.show { display: block; }
        .dropdown-content button {
            width: 100%; padding: 10px; background: none; border: 0;
            color: white; text-align: left; cursor: pointer; font-size: 12px;
        }
        .dropdown-content button:hover { background: #333; }
        
        .dropdown-content button.active-layout {
            color: var(--primary-color);
            background: #252525;
            font-weight: bold;
        }
        .dropdown-content button.active-layout::before { content: "‚úì "; }

        .pdfWrap { height: 100%; display: flex; flex-direction: column; }
        .pdfTop { padding: 6px; background: #0b0b0b; border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center; font-size: 11px; }

        .modalBack {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; place-items: center; z-index: 2000;
        }
        .modalBack.open { display: grid; }
        .modal { width: 380px; background: #111; border: 1px solid #333; border-radius: 12px; padding: 20px; }
        .row { margin-bottom: 12px; display: flex; flex-direction: column; gap: 6px; }
        input { padding: 8px; background: #000; border: 1px solid #444; color: #fff; border-radius: 6px; }
    </style>
</head>
<body>

<div class="root layout-double" id="main-grid">
    <section class="stack" id="col-0">
        <header class="tabs">
            <div class="tabs-rail" id="rail-0" ondragover="allowDrop(event)" ondragenter="handleDragEnterRail(0)" ondragleave="handleDragLeaveRail(0)" ondrop="handleDropRail(event, 0)"></div>
            <div class="actions">
                <button class="iconbtn" onclick="toggleFS(0)">‚õ∂</button>
                <div class="dropdown">
                    <button class="iconbtn" onclick="toggleAddMenu(event, 0)">+</button>
                    <div class="dropdown-content" id="addMenu-0">
                        <button onclick="openModal(0)">üåê URL Personalizada</button>
                        <button onclick="addPdfTab(0)">üìÑ Nuevo PDF Viewer</button>
                        <hr style="border: 0; border-top: 1px solid #333; margin: 4px 0;">
                        </div>
                </div>
                <button class="iconbtn" onclick="resetConfig()">Reset</button>
            </div>
        </header>
        <div class="panel" id="panel-0"></div>
    </section>

    <section class="stack" id="col-1">
        <header class="tabs">
            <div class="tabs-rail" id="rail-1" ondragover="allowDrop(event)" ondragenter="handleDragEnterRail(1)" ondragleave="handleDragLeaveRail(1)" ondrop="handleDropRail(event, 1)"></div>
            <div class="actions">
                <button class="iconbtn" onclick="toggleFS(1)">‚õ∂</button>
                <div class="dropdown">
                    <button class="iconbtn" onclick="toggleAddMenu(event, 1)">+</button>
                    <div class="dropdown-content" id="addMenu-1">
                        <button onclick="openModal(1)">üåê URL Personalizada</button>
                        <button onclick="addPdfTab(1)">üìÑ Nuevo PDF Viewer</button>
                        <hr style="border: 0; border-top: 1px solid #333; margin: 4px 0;">
                        </div>
                </div>
                <div class="dropdown">
                    <button class="iconbtn" id="layoutBtn" style="background:var(--primary-color);color:#000;font-weight:bold" onclick="toggleDropdown(event)">Layout ‚ñæ</button>
                    <div class="dropdown-content" id="layoutMenu">
                        <button id="opt-double" onclick="changeLayout('double')">Doble Vertical</button>
                        <button id="opt-triple-h" onclick="changeLayout('triple-h')">Triple Horizontal</button>
                        <button id="opt-triple-v" onclick="changeLayout('triple-v')">Triple Vertical</button>
                    </div>
                </div>
            </div>
        </header>
        <div class="panel" id="panel-1"></div>
    </section>

    <section class="stack" id="col-2" style="display: none;">
        <header class="tabs">
            <div class="tabs-rail" id="rail-2" ondragover="allowDrop(event)" ondragenter="handleDragEnterRail(2)" ondragleave="handleDragLeaveRail(2)" ondrop="handleDropRail(event, 2)"></div>
            <div class="actions">
                <button class="iconbtn" onclick="toggleFS(2)">‚õ∂</button>
                <div class="dropdown">
                    <button class="iconbtn" onclick="toggleAddMenu(event, 2)">+</button>
                    <div class="dropdown-content" id="addMenu-2">
                        <button onclick="openModal(2)">üåê URL Personalizada</button>
                        <button onclick="addPdfTab(2)">üìÑ Nuevo PDF Viewer</button>
                        <hr style="border: 0; border-top: 1px solid #333; margin: 4px 0;">
                    </div>
                </div>
            </div>
        </header>
        <div class="panel" id="panel-2"></div>
    </section>
</div>

<div class="modalBack" id="modal">
    <div class="modal">
        <h3 style="margin-top:0">A√±adir pesta√±a</h3>
        <div class="row"><label>Nombre</label><input type="text" id="m-name"></div>
        <div class="row"><label>URL</label><input type="text" id="m-url"></div>
        <div style="display:flex; justify-content: flex-end; gap: 8px;">
            <button class="iconbtn" onclick="closeModal()">Cancelar</button>
            <button class="iconbtn" style="background:var(--primary-color);color:#000" onclick="saveTab()">Guardar</button>
        </div>
    </div>
</div>

<script>
    const BASE_URLS = {
        Tracker: 'https://vagtal.github.io/notion-init-tracker-plugin.github.io/',
        RollForFantasy: 'https://rollforfantasy.com/',
        RabdRoll: 'https://www.randroll.com/30-days-gen-sites/',
        Drive: 'http://127.0.0.1:9090/',
        Player: 'https://vagtal.github.io/player',
        Notes: 'https://vagtal.github.io/notes',
        Sound: 'https://app.syrinscape.com/#/?soundset=3&element=1565315'
    };

    const DEFAULT_TABS = [
        { key: 't1', title: 'Player', type: 'URL', column: 0, url: BASE_URLS.Player },
        { key: 't2', title: 'PDF Viewer', type: 'PDF', column: 0, url: 'about:blank' },
        { key: 't3', title: 'Notes', type: 'URL', column: 0, url: BASE_URLS.Notes },
        { key: 't4', title: 'Drive', type: 'URL', column: 0, url: BASE_URLS.Drive },
        { key: 't5', title: 'Tracker', type: 'URL', column: 1, url: BASE_URLS.Tracker },
        { key: 't6', title: 'RollForFantasy', type: 'URL', column: 1, url: BASE_URLS.RollForFantasy },
        { key: 't7', title: 'RabdRoll', type: 'URL', column: 1, url: BASE_URLS.RabdRoll },
        { key: 't8', title: 'Sound', type: 'URL', column: 1, url: BASE_URLS.Sound }
    ];

    let tabs = JSON.parse(localStorage.getItem('rpg_tabs')) || DEFAULT_TABS;
    let activeKeys = JSON.parse(localStorage.getItem('rpg_active_keys')) || { 0: 't1', 1: 't3', 2: '' };
    let currentLayout = localStorage.getItem('rpg_layout') || 'double';

    function toggleDropdown(e) {
        e.stopPropagation();
        document.getElementById('layoutMenu').classList.toggle('show');
        updateLayoutMenuUI();
    }

    function updateLayoutMenuUI() {
        ['double', 'triple-h', 'triple-v'].forEach(opt => {
            const btn = document.getElementById(`opt-${opt}`);
            if (btn) btn.classList.toggle('active-layout', currentLayout === opt);
        });
    }

    window.onclick = function() {
        document.querySelectorAll('.dropdown-content').forEach(menu => {
            menu.classList.remove('show');
        });
    }

    function changeLayout(mode) {
        if (mode.startsWith('triple') && tabs.length < 3) {
            alert("A√±ade al menos 3 pesta√±as para activar este layout.");
            return;
        }

        if (mode.startsWith('triple')) {
            const panelsContent = [0, 1, 2].map(i => tabs.filter(t => t.column === i).length);
            if (panelsContent[2] === 0) {
                const sourceCol = panelsContent[0] > panelsContent[1] ? 0 : 1;
                const colTabs = tabs.filter(t => t.column === sourceCol);
                if (colTabs.length > 1) {
                    const tabToMove = colTabs[colTabs.length - 1];
                    tabToMove.column = 2;
                    activeKeys[2] = tabToMove.key;
                }
            }
        } else if (mode === 'double') {
            tabs.forEach(t => { if(t.column === 2) t.column = 1; });
        }

        currentLayout = mode;
        localStorage.setItem('rpg_layout', mode);
        syncDOM();
    }

    function toggleAddMenu(e, colIdx) {
        e.stopPropagation();
        
        // 1. Cerrar todos los dem√°s men√∫s antes de abrir este
        document.querySelectorAll('.dropdown-content').forEach(el => {
            if (el.id !== `addMenu-${colIdx}`) el.classList.remove('show');
        });
        
        const menu = document.getElementById(`addMenu-${colIdx}`);
        
        // 2. Limpiar y Regenerar contenido para asegurar que el colIdx es correcto
        // Mantenemos las dos opciones fijas primero
        menu.innerHTML = `
            <button onclick="openModal(${colIdx})">üåê URL Personalizada</button>
            <button onclick="addPdfTab(${colIdx})">üìÑ Nuevo PDF Viewer</button>
            <hr style="border: 0; border-top: 1px solid #333; margin: 4px 0;">
        `;
        
        // 3. Cargar din√°micamente la lista de BASE_URLS
        for (const [name, url] of Object.entries(BASE_URLS)) {
            const btn = document.createElement('button');
            btn.textContent = `üìç ${name}`;
            btn.onclick = () => addPredefinedTab(name, url, colIdx);
            menu.appendChild(btn);
        }
        
        menu.classList.toggle('show');
    }

    // Funci√≥n para a√±adir una pesta√±a de la lista predefinida
    function addPredefinedTab(name, url, colIdx) {
        const key = 'pre_' + Date.now() + Math.random().toString(36).substr(2, 5);
        tabs.push({ 
            key, 
            title: name, 
            url, 
            column: colIdx, 
            isDynamic: true, 
            type: 'URL' 
        });
        activeKeys[colIdx] = key;
        syncDOM();
        // El men√∫ se cerrar√° por el window.onclick global que ya tienes
    }

    function addPdfTab(colIdx) {
        // Generamos una clave √∫nica basada en el tiempo
        const key = 'pdf_' + Date.now();
        
        // Insertamos el objeto en el array de pesta√±as
        tabs.push({ 
            key: key, 
            title: 'PDF Viewer', 
            url: 'about:blank', // Se inicia vac√≠o hasta que el usuario sube el archivo
            column: colIdx, 
            type: 'PDF', 
            isDynamic: true 
        });
        
        // Hacemos que la nueva pesta√±a sea la activa en esa columna
        activeKeys[colIdx] = key;
        
        // Refrescamos el DOM para que aparezca
        syncDOM();
    }

   function syncDOM() {
        const grid = document.getElementById('main-grid');
        grid.className = `root layout-${currentLayout}`;
        const colLimit = currentLayout === 'double' ? 2 : 3;

        [0, 1, 2].forEach(colIdx => {
            const rail = document.getElementById(`rail-${colIdx}`);
            const panel = document.getElementById(`panel-${colIdx}`);
            const stack = document.getElementById(`col-${colIdx}`);
            const colTabs = tabs.filter(t => t.column === colIdx);

            if (colIdx >= colLimit) {
                stack.style.display = 'none';
                return;
            }
            stack.style.display = 'flex';

            const isActiveValid = colTabs.some(t => t.key === activeKeys[colIdx]);
            if (!isActiveValid && colTabs.length > 0) activeKeys[colIdx] = colTabs[0].key;

            rail.innerHTML = '';
            colTabs.forEach(tab => {
                const isActive = activeKeys[colIdx] === tab.key;
                const btn = document.createElement('button');
                btn.className = `tab ${isActive ? 'active' : ''} ${tab.isDynamic ? 'dyn' : ''}`;
                btn.draggable = true;
                btn.innerHTML = `${tab.title} <span class="close" onclick="closeTab(event, '${tab.key}', ${colIdx})">‚úï</span>`;
                
                // --- BLOQUEO MEN√ö CONTEXTUAL ---
                btn.addEventListener("contextmenu", (e) => {
                    e.preventDefault(); 
                }, false);
                
                // EVENTOS DE CLICK
                btn.onclick = () => { activeKeys[colIdx] = tab.key; syncDOM(); };

                // EVENTOS DE DRAG & DROP
                btn.ondragstart = (e) => { 
                    e.dataTransfer.setData('text', tab.key); 
                    setTimeout(() => btn.classList.add('dragging'), 0);
                };
                
                btn.ondragend = () => {
                    btn.classList.remove('dragging');
                    document.querySelectorAll('.tabs-rail').forEach(r => r.classList.remove('drag-target'));
                };

                btn.ondragover = (e) => { 
                    e.preventDefault(); 
                    if (!btn.classList.contains('dragging')) {
                        btn.classList.add('drag-over'); 
                    }
                };

                btn.ondragleave = () => btn.classList.remove('drag-over');

                btn.ondrop = (e) => {
                    btn.classList.remove('drag-over');
                    handleDropTab(e, tab.key, colIdx);
                };

                rail.appendChild(btn);
            });

            // LIMPIEZA DE PANALES ANTIGUOS
            const targetKeys = colTabs.map(t => t.key);
            panel.querySelectorAll('.tab-pane').forEach(p => { 
                if (!targetKeys.includes(p.dataset.key)) p.remove(); 
            });

            // RENDERIZADO DE CONTENIDO (URL vs PDF)
            colTabs.forEach(tab => {
                let pane = panel.querySelector(`.tab-pane[data-key="${tab.key}"]`);
                if (!pane) {
                    pane = document.createElement('div');
                    pane.className = 'tab-pane';
                    pane.dataset.key = tab.key;
                    
                    // --- CAMBIO AQU√ç: SOPORTE PDF ---
                    if (tab.type === 'PDF') {
                        pane.innerHTML = `
                            <div class="pdfWrap">
                                <div class="pdfTop">
                                    <span>PDF:</span>
                                    <input type="file" accept="application/pdf" onchange="loadPdf(event, '${tab.key}')">
                                </div>
                                <iframe id="pdf-${tab.key}" src="${tab.blobUrl || 'about:blank'}"></iframe>
                            </div>`;
                    } else {
                        pane.innerHTML = `<iframe src="${tab.url}"></iframe>`;
                    }
                    // --------------------------------
                    
                    panel.appendChild(pane);
                }
                pane.classList.toggle('active', activeKeys[colIdx] === tab.key);
            });
        });
        save();
    }

    function save() {
        localStorage.setItem('rpg_tabs', JSON.stringify(tabs));
        localStorage.setItem('rpg_active_keys', JSON.stringify(activeKeys));
    }

    function closeTab(e, key, colIdx) {
        e.stopPropagation();
        const tabsInPanel = tabs.filter(t => t.column === colIdx).length;
        if (tabsInPanel <= 1) {
            alert("No puedes dejar un panel vac√≠o. Mueve otra pesta√±a aqu√≠ o a√±ade una nueva antes de cerrar esta.");
            return;
        }
        tabs = tabs.filter(t => t.key !== key);
        syncDOM();
    }

    // FEEDBACK VISUAL PARA EL RAIL
    function handleDragEnterRail(colIdx) {
        document.getElementById(`rail-${colIdx}`).classList.add('drag-target');
    }

    function handleDragLeaveRail(colIdx) {
        document.getElementById(`rail-${colIdx}`).classList.remove('drag-target');
    }

    function handleDropRail(e, colIdx) {
        e.preventDefault();
        handleDragLeaveRail(colIdx);
        const srcKey = e.dataTransfer.getData('text');
        const tab = tabs.find(t => t.key === srcKey);
        if (tab) { tab.column = colIdx; activeKeys[colIdx] = srcKey; syncDOM(); }
    }

    function handleDropTab(e, targetKey, colIdx) {
        e.preventDefault(); e.stopPropagation();
        const srcKey = e.dataTransfer.getData('text');
        if (srcKey === targetKey) return;
        const srcIdx = tabs.findIndex(t => t.key === srcKey);
        const [moved] = tabs.splice(srcIdx, 1);
        moved.column = colIdx;
        const targetIdx = tabs.findIndex(t => t.key === targetKey);
        tabs.splice(targetIdx, 0, moved);
        activeKeys[colIdx] = srcKey;
        syncDOM();
    }

    function allowDrop(e) { e.preventDefault(); }

    function loadPdf(e, key) {
        console.log(e.target)
        const file = e.target.files[0];
        if (file) {
            const url = URL.createObjectURL(file);
            const tab = tabs.find(t => t.key === key);
            if (tab) {
                tab.blobUrl = url;
                const iframe = document.getElementById(`pdf-${key}`);
                if (iframe) iframe.src = url;
                e.target.parentElement.style.display = 'none';
                save();
            }
        }
    }

    function toggleFS(col) {
        const el = document.getElementById(`col-${col}`);
        if (!document.fullscreenElement) el.requestFullscreen().catch(e => console.error(e));
        else document.exitFullscreen();
    }

    function resetConfig() {
        if(confirm("¬øResetear toda la configuraci√≥n y pesta√±as?")) { 
            localStorage.clear(); 
            location.reload(); 
        }
    }

    function openModal(col) { 
        window.currentModalCol = col; 
        document.getElementById('modal').classList.add('open'); 
        document.getElementById('m-name').focus();
    }
    
    function closeModal() { 
        document.getElementById('modal').classList.remove('open'); 
    }

    function saveTab() {
        const name = document.getElementById('m-name').value;
        const url = document.getElementById('m-url').value;
        if (name && url) {
            const key = 'dyn_' + Date.now();
            tabs.push({ key, title: name, url, column: window.currentModalCol, isDynamic: true, type: 'URL' });
            activeKeys[window.currentModalCol] = key;
            syncDOM(); 
            closeModal();
            document.getElementById('m-name').value = '';
            document.getElementById('m-url').value = '';
        }
    }

    syncDOM();
</script>
</body>
</html>